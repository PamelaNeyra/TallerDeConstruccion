DELIMITER//
CREATE PROCEDURE SP_Listar_Presentaciones (id_planta INT)
BEGIN
	DECLARE cursor_lista CURSOR FOR SELECT id_presentacion, descripcion FROM presentacion  WHERE presentacion.id_planta=id_planta;
END


DELIMITER //
CREATE PROCEDURE SP_Registrar_Lote (id_lote VARCHAR(20),id_planta INT, fecha_prod DATE, cant_recepcion DOUBLE, cant_total DOUBLE)
BEGIN
	DECLARE dias_captura INT;
	DECLARE fch_captura DATE;
	DECLARE anios_vence INT;
	DECLARE fch_vence DATE;
	DECLARE rend DOUBLE;

	SET dias_captura = (SELECT dias_expira FROM constantes WHERE constantes.id_planta=id_planta);
	SET fch_captura = (SELECT DATE_SUB(fecha_prod, INTERVAL dias_captura DAY));

	SET anios_vence = (SELECT anios_vencimiento FROM constantes WHERE constantes.id_planta=id_planta);
	SET fch_vence = (SELECT DATE_SUB(fecha_prod,INTERVAL anios_vence YEAR));

	SET rend = cant_total/cant_recepcion;

	INSERT INTO lote (id_lote,id_planta,fecha_produccion,fecha_captura,fecha_vencimiento,cantidad_recepcion,cantidad_total,rendimiento) VALUES (id_lote,id_planta,fecha_prod,fch_captura,fch_vence,cant_recepcion,cant_total,rend);
	

END

DELIMITER //
CREATE PROCEDURE SP_Registrar_Contenido (id_lote VARCHAR(20),id_presentacion VARCHAR(20), cantidad DOUBLE)
BEGIN
	INSERT INTO contenido (id_lote,id_presentacion,cantidad) VALUES (id_lote,id_presentacion,cantidad);
END


DELIMITER //
CREATE TRIGGER T_Actualizar_Planta_Presentacion AFTER INSERT ON contenido
	FOR EACH ROW
    BEGIN
	DECLARE cant_anterior DOUBLE;
	DECLARE cant_recepcion DOUBLE;
	DECLARE planta INT;

	SET cant_anterior = (SELECT cantidad_total FROM planta_presentacion WHERE planta_presentacion.id_presentacion = NEW.id_presentacion);

	SET planta = (SELECT id_planta FROM lote WHERE id_lote = NEW.id_lote);

	SET cant_recepcion = (SELECT cantidad_recepcion FROM lote WHERE id_lote=NEW.id_lote AND id_planta=planta);
	
	UPDATE planta_presentacion SET cantidad_total = cant_recepcion + cant_anterior WHERE id_presentacion = NEW.id_presentacion AND id_planta = planta ;

END




